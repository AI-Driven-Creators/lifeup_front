import{d as C,r as y,a as n,b as l,i as m,f as _,t as c,F as B,e as S,j as U,o,k as F,l as E,u as j,m as P,g as f,_ as L}from"./index-BETfxjSh.js";const M={class:"card hover:shadow-md transition-shadow"},N={class:"flex items-center justify-between"},V={class:"flex-1 min-w-0"},z={class:"flex items-center space-x-4 text-sm text-primary-700 mb-2"},A={class:"flex items-center"},D={class:"flex items-center text-primary-600 font-medium"},I={key:0,class:"text-sm text-primary-700 mb-3"},O={key:0,class:"ml-4 flex space-x-2"},X=["disabled"],q=["disabled"],G=["disabled"],H=["disabled"],J={key:4,class:"px-3 py-1 bg-gray-400 text-white rounded text-sm"},K={key:5,class:"px-3 py-1 bg-gray-400 text-white rounded text-sm"},Q={class:"flex items-center justify-between mt-3"},R={class:"flex items-center space-x-1"},W=C({__name:"MissionTaskCard",props:{task:{}},emits:["toggle","taskUpdated"],setup(w,{emit:i}){const r=w,d=i,s=y(!1),b=()=>{d("toggle",r.task.id)},k=async()=>{s.value=!0;try{const e=await U.startTask(r.task.id);if(e.success){const t={...r.task,status:"in_progress"};d("taskUpdated",t),console.log(e.message)}else alert(`開始任務失敗: ${e.message}`)}catch(e){console.error("Failed to start task:",e),alert("開始任務失敗")}finally{s.value=!1}},v=async()=>{s.value=!0;try{const e=await U.pauseTask(r.task.id);if(e.success){const t={...r.task,status:"paused"};d("taskUpdated",t),console.log(e.message)}else alert(`暫停任務失敗: ${e.message}`)}catch(e){console.error("Failed to pause task:",e),alert("暫停任務失敗")}finally{s.value=!1}},g=async()=>{if(confirm("確定要取消此任務嗎？相關的子任務將會被刪除。")){s.value=!0;try{const e=await U.cancelTask(r.task.id);if(e.success){const t={...r.task,status:"cancelled"};d("taskUpdated",t),console.log(e.message)}else alert(`取消任務失敗: ${e.message}`)}catch(e){console.error("Failed to cancel task:",e),alert("取消任務失敗")}finally{s.value=!1}}},x=e=>({main:"主線",side:"支線",challenge:"挑戰",daily:"每日",subtask:"子任務"})[e],h=e=>({main:"bg-blue-100 text-blue-800",side:"bg-green-100 text-green-800",challenge:"bg-purple-100 text-purple-800",daily:"bg-orange-100 text-orange-800",subtask:"bg-gray-100 text-gray-800"})[e];return(e,t)=>(o(),n("div",M,[l("div",N,[l("div",V,[l("h3",{class:_(["font-medium text-primary-900 mb-1",{"line-through text-primary-700":e.task.status==="completed"}])},c(e.task.title),3),l("div",z,[l("span",A," 等級："+c(e.task.difficulty),1),l("span",D," 成長："+c(e.task.experience)+" XP ",1)]),e.task.description?(o(),n("p",I,c(e.task.description),1)):m("",!0)]),e.task.is_parent_task?(o(),n("div",O,[e.task.status==="pending"?(o(),n("button",{key:0,class:"px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors",onClick:k,disabled:s.value},c(s.value?"處理中...":"開始"),9,X)):m("",!0),e.task.status==="in_progress"?(o(),n("button",{key:1,class:"px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700 transition-colors",onClick:v,disabled:s.value},c(s.value?"處理中...":"暫停"),9,q)):m("",!0),e.task.status==="paused"?(o(),n("button",{key:2,class:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors",onClick:k,disabled:s.value},c(s.value?"處理中...":"繼續"),9,G)):m("",!0),["pending","in_progress","paused"].includes(e.task.status)?(o(),n("button",{key:3,class:"px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors",onClick:g,disabled:s.value},c(s.value?"處理中...":"取消"),9,H)):m("",!0),e.task.status==="completed"?(o(),n("span",J," 已完成 ")):m("",!0),e.task.status==="cancelled"?(o(),n("span",K," 已取消 ")):m("",!0)])):(o(),n("button",{key:1,class:_(["btn-primary ml-4",{"bg-gray-400":e.task.status==="completed"}]),onClick:b},c(e.task.status==="completed"?"已完成":"開始"),3))]),l("div",Q,[l("span",{class:_(["inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",h(e.task.type)])},c(x(e.task.type)),3),l("div",R,[(o(),n(B,null,S(5,a=>l("span",{key:a,class:_(["text-xs",a<=e.task.difficulty?"text-yellow-400":"text-gray-300"])}," ★ ",2)),64))])])]))}}),Y={class:"space-y-3"},Z={class:"text-lg font-bold text-primary-900"},ee={class:"space-y-3"},T=C({__name:"TaskSection",props:{title:{},tasks:{}},emits:["toggle","taskUpdated"],setup(w){return(i,r)=>(o(),n("div",Y,[l("h2",Z,c(i.title),1),l("div",ee,[(o(!0),n(B,null,S(i.tasks,d=>(o(),F(W,{key:d.id,task:d,onToggle:r[0]||(r[0]=s=>i.$emit("toggle",s)),onTaskUpdated:r[1]||(r[1]=s=>i.$emit("taskUpdated",s))},null,8,["task"]))),128))])]))}}),se={class:"min-h-screen bg-primary-50"},te={key:0,class:"px-4 py-8 text-center"},ae={key:1,class:"px-4 py-4"},le={class:"bg-red-50 border border-red-200 rounded-lg p-4"},oe={class:"flex items-center"},ne={class:"text-red-600 text-sm mt-1"},re={key:2,class:"px-4 py-6 space-y-6"},de=C({__name:"MissionPage",setup(w){const i=E(),r=j(),d=y([]),s=y([]),b=y([]),k=y([]),v=y(!0),g=y(null),x=async()=>{v.value=!0,g.value=null;try{const[t,a,u,p]=await Promise.all([i.fetchTasksByType("main"),i.fetchTasksByType("side"),i.fetchTasksByType("challenge"),i.fetchTasksByType("daily")]);d.value=t,s.value=a,b.value=u,k.value=p}catch(t){g.value=t instanceof Error?t.message:"載入任務失敗",console.error("Failed to load tasks by type:",t)}finally{v.value=!1}},h=async t=>{try{await i.toggleTaskStatus(t);const u=[...d.value,...s.value,...b.value,...k.value].find(p=>p.id===t);u&&u.status==="completed"&&(r.updateExperience(u.experience),u.attributes&&Object.entries(u.attributes).forEach(([p,$])=>{r.updateAttribute(p,$)}))}catch(a){g.value=a instanceof Error?a.message:"更新任務狀態失敗",console.error("Failed to toggle task:",a)}},e=t=>{const a=u=>{const p=u.findIndex($=>$.id===t.id);p!==-1&&(u[p]=t)};switch(t.type){case"main":a(d.value);break;case"side":a(s.value);break;case"challenge":a(b.value);break;case"daily":a(k.value);break}};return P(()=>{x()}),(t,a)=>(o(),n("div",se,[f(L,{title:"任務"}),v.value?(o(),n("div",te,a[0]||(a[0]=[l("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1),l("p",{class:"mt-2 text-gray-600"},"載入任務中...",-1)]))):g.value?(o(),n("div",ae,[l("div",le,[l("div",oe,[a[2]||(a[2]=l("div",{class:"text-red-600 mr-3"},"⚠️",-1)),l("div",null,[a[1]||(a[1]=l("h3",{class:"text-red-800 font-medium"},"載入失敗",-1)),l("p",ne,c(g.value),1)])]),l("button",{onClick:x,class:"mt-3 px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-colors"}," 重試 ")])])):(o(),n("div",re,[f(T,{title:"主線任務",tasks:d.value,onToggle:h,onTaskUpdated:e},null,8,["tasks"]),f(T,{title:"支線任務",tasks:s.value,onToggle:h,onTaskUpdated:e},null,8,["tasks"]),f(T,{title:"挑戰任務",tasks:b.value,onToggle:h,onTaskUpdated:e},null,8,["tasks"]),f(T,{title:"每日任務",tasks:k.value,onToggle:h,onTaskUpdated:e},null,8,["tasks"])]))]))}});export{de as default};
